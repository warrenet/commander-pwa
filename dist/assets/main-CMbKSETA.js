import"./style-BaP5DkCu.js";const ve=(e,t)=>t.some(n=>e instanceof n);let Me,$e;function Tt(){return Me||(Me=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function It(){return $e||($e=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const we=new WeakMap,ge=new WeakMap,ce=new WeakMap;function Lt(e){const t=new Promise((n,o)=>{const a=()=>{e.removeEventListener("success",i),e.removeEventListener("error",r)},i=()=>{n(C(e.result)),a()},r=()=>{o(e.error),a()};e.addEventListener("success",i),e.addEventListener("error",r)});return ce.set(t,e),t}function Ct(e){if(we.has(e))return;const t=new Promise((n,o)=>{const a=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",r),e.removeEventListener("abort",r)},i=()=>{n(),a()},r=()=>{o(e.error||new DOMException("AbortError","AbortError")),a()};e.addEventListener("complete",i),e.addEventListener("error",r),e.addEventListener("abort",r)});we.set(e,t)}let xe={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return we.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return C(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function Ye(e){xe=e(xe)}function Bt(e){return It().includes(e)?function(...t){return e.apply(ke(this),t),C(this.request)}:function(...t){return C(e.apply(ke(this),t))}}function Dt(e){return typeof e=="function"?Bt(e):(e instanceof IDBTransaction&&Ct(e),ve(e,Tt())?new Proxy(e,xe):e)}function C(e){if(e instanceof IDBRequest)return Lt(e);if(ge.has(e))return ge.get(e);const t=Dt(e);return t!==e&&(ge.set(e,t),ce.set(t,e)),t}const ke=e=>ce.get(e);function At(e,t,{blocked:n,upgrade:o,blocking:a,terminated:i}={}){const r=indexedDB.open(e,t),s=C(r);return o&&r.addEventListener("upgradeneeded",c=>{o(C(r.result),c.oldVersion,c.newVersion,C(r.transaction),c)}),n&&r.addEventListener("blocked",c=>n(c.oldVersion,c.newVersion,c)),s.then(c=>{i&&c.addEventListener("close",()=>i()),a&&c.addEventListener("versionchange",d=>a(d.oldVersion,d.newVersion,d))}).catch(()=>{}),s}const Ot=["get","getKey","getAll","getAllKeys","count"],Mt=["put","add","delete","clear"],fe=new Map;function Ne(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(fe.get(t))return fe.get(t);const n=t.replace(/FromIndex$/,""),o=t!==n,a=Mt.includes(n);if(!(n in(o?IDBIndex:IDBObjectStore).prototype)||!(a||Ot.includes(n)))return;const i=async function(r,...s){const c=this.transaction(r,a?"readwrite":"readonly");let d=c.store;return o&&(d=d.index(s.shift())),(await Promise.all([d[n](...s),a&&c.done]))[0]};return fe.set(t,i),i}Ye(e=>({...e,get:(t,n,o)=>Ne(t,n)||e.get(t,n,o),has:(t,n)=>!!Ne(t,n)||e.has(t,n)}));const $t=["continue","continuePrimaryKey","advance"],Pe={},Ee=new WeakMap,Qe=new WeakMap,Nt={get(e,t){if(!$t.includes(t))return e[t];let n=Pe[t];return n||(n=Pe[t]=function(...o){Ee.set(this,Qe.get(this)[t](...o))}),n}};async function*Pt(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const n=new Proxy(t,Nt);for(Qe.set(n,t),ce.set(n,ke(t));t;)yield n,t=await(Ee.get(n)||t.continue()),Ee.delete(n)}function Re(e,t){return t===Symbol.asyncIterator&&ve(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&ve(e,[IDBIndex,IDBObjectStore])}Ye(e=>({...e,get(t,n,o){return Re(t,n)?Pt:e.get(t,n,o)},has(t,n){return Re(t,n)||e.has(t,n)}}));const Ze="commander-db",Xe=3,j="documents",H="pending",Ce=3;let P=null;async function z(){return P||(P=await At(Ze,Xe,{upgrade(e,t,n){console.log(`[DB] Upgrading from v${t} to v${n}`),e.objectStoreNames.contains(j)||e.createObjectStore(j,{keyPath:"id"}),e.objectStoreNames.contains(H)||e.createObjectStore(H,{keyPath:"id"})}}),await Rt(),P)}async function Rt(){const e=await P.get(j,"main");if(!e)return;let t=!1;const n={...e};n.schemaVersion||(console.log("[DB] Migrating: Adding schemaVersion"),n.schemaVersion=1,t=!0),n.schemaVersion<2&&(console.log("[DB] Migrating v1 â†’ v2: Ensuring logs array"),Array.isArray(n.logs)||(n.logs=[]),n.schemaVersion=2,t=!0),n.schemaVersion<3&&(console.log("[DB] Migrating v2 â†’ v3: Ensuring shipped array"),Array.isArray(n.shipped)||(n.shipped=[]),["inbox","next","shipToday"].forEach(o=>{Array.isArray(n[o])&&(n[o]=n[o].map((a,i)=>a.id?a:{...a,id:`migrated_${o}_${i}_${Date.now()}`}))}),n.schemaVersion=3,t=!0),t&&(console.log("[DB] Saving migrated document"),await K(n))}async function K(e){const n=(await z()).transaction(j,"readwrite");await n.store.put({id:"main",schemaVersion:Ce,...e,updatedAt:Date.now()}),await n.done,await Ft()}async function et(){const e=await z(),t=await e.get(H,"main");return t?(console.log("[DB] Recovering from pending write"),await K(t),t):e.get(j,"main")}async function Ut(e){const n=(await z()).transaction(H,"readwrite");await n.store.put({id:"main",...e,pendingAt:Date.now()}),await n.done}async function Ft(){const t=(await z()).transaction(H,"readwrite");await t.store.delete("main"),await t.done}function Be(){return{schemaVersion:Ce,inbox:[],next:[],shipToday:[],logs:[],shipped:[]}}async function tt(){var e,t,n,o,a;try{const i=await et();return{dbName:Ze,dbVersion:Xe,schemaVersion:(i==null?void 0:i.schemaVersion)||"unknown",itemCounts:{inbox:((e=i==null?void 0:i.inbox)==null?void 0:e.length)||0,next:((t=i==null?void 0:i.next)==null?void 0:t.length)||0,shipToday:((n=i==null?void 0:i.shipToday)==null?void 0:n.length)||0,logs:((o=i==null?void 0:i.logs)==null?void 0:o.length)||0,shipped:((a=i==null?void 0:i.shipped)==null?void 0:a.length)||0},lastUpdated:i!=null&&i.updatedAt?new Date(i.updatedAt).toISOString():"never"}}catch(i){return{error:i.message}}}const Wt=[{pattern:/\b(buy|get|pick up|grab|shop)\b/i,tag:"#errand"},{pattern:/\b(groceries|store|market)\b/i,tag:"#errand"},{pattern:/\b(fix|debug|code|deploy|refactor|test)\b/i,tag:"#dev"},{pattern:/\b(bug|error|crash|issue)\b/i,tag:"#dev"},{pattern:/\b(API|database|server|frontend|backend)\b/i,tag:"#dev"},{pattern:/\b(call|email|text|message|reach out|contact)\b/i,tag:"#comms"},{pattern:/\b(meet|meeting|sync|standup)\b/i,tag:"#comms"},{pattern:/\b(exercise|workout|gym|run|walk|yoga)\b/i,tag:"#health"},{pattern:/\b(doctor|dentist|appointment|medication)\b/i,tag:"#health"},{pattern:/\b(pay|bill|invoice|budget|expense|money)\b/i,tag:"#finance"},{pattern:/\b(bank|transfer|deposit)\b/i,tag:"#finance"},{pattern:/\b(read|learn|study|research|course)\b/i,tag:"#learn"},{pattern:/\b(book|article|tutorial|video)\b/i,tag:"#learn"},{pattern:/\b(clean|organize|laundry|dishes|vacuum)\b/i,tag:"#home"},{pattern:/\b(repair|fix|maintenance)\b/i,tag:"#home"},{pattern:/\b(report|presentation|proposal|deadline)\b/i,tag:"#work"},{pattern:/\b(client|project|task|review)\b/i,tag:"#work"},{pattern:/\b(urgent|asap|important|critical)\b/i,tag:"#priority"},{pattern:/\b(today|now|immediately)\b/i,tag:"#priority"},{pattern:/\b(waiting|blocked|pending|on hold)\b/i,tag:"#waiting"}];function Vt(e){if(!e||typeof e!="string")return[];const t=new Set;for(const n of Wt)n.pattern.test(e)&&t.add(n.tag);return Array.from(t)}let l=Be(),U=null,Z=null;const Se=new Set;let le="idle",De="tasks";const jt=300;function ne(){return Date.now().toString(36)+Math.random().toString(36).substr(2,5)}function y(){return l}function de(){return le}function X(){return De}function v(e){De=e,g()}function Ht(e){return Se.add(e),()=>Se.delete(e)}function g(){Se.forEach(e=>e(l,le,De))}function Y(e){le=e,g()}function E(){Z&&clearTimeout(Z),Ut(l).catch(console.error),Y("saving"),Z=setTimeout(async()=>{try{await K(l),Y("saved"),setTimeout(()=>{le==="saved"&&Y("idle")},2e3)}catch(e){console.error("[State] Save failed:",e),Y("error")}},jt)}function w(){U=JSON.parse(JSON.stringify(l))}async function Ue(){try{const e=await et();e&&(l={inbox:e.inbox||[],next:e.next||[],shipToday:e.shipToday||[],logs:e.logs||[]}),g()}catch(e){console.error("[State] Failed to load:",e),l=Be(),g()}}function O(e,t="",n=[]){w();const o=Vt(t),a=[...new Set([...n,...o])],i={id:ne(),text:t,tags:a.length>0?a:void 0,createdAt:Date.now()};return l[e]=[...l[e],i],E(),g(),i.id}function Te(e,t,n){l[e].findIndex(a=>a.id===t)!==-1&&(Z||w(),l[e]=l[e].map(a=>a.id===t?{...a,text:n}:a),E(),g())}function nt(e,t){w(),l[e]=l[e].filter(n=>n.id!==t),E(),g()}function Gt(e,t,n){if(e===t)return;w();const o=l[e].find(a=>a.id===n);o&&(l[e]=l[e].filter(a=>a.id!==n),l[t]=[...l[t],o],E(),g())}function _t(){w(),l=Be(),E(),g()}function qt(){if(!U)return!1;const e=l;return l=U,U=e,E(),g(),!0}function zt(){return U!==null}async function Kt(e){w(),l={inbox:Array.isArray(e.inbox)?e.inbox:[],next:Array.isArray(e.next)?e.next:[],shipToday:Array.isArray(e.shipToday)?e.shipToday:[],logs:Array.isArray(e.logs)?e.logs:[]},await K(l),g()}function ue(e,t="manual",n="logs",o=[]){w();const a=e.trim();if(l.logs.length>0){const r=l.logs[0];if(r.content===a)return console.log("[State] Duplicate log ignored"),r.id}const i={id:ne(),createdAt:new Date().toISOString(),source:t,route:n,tags:o,content:a};if(l.logs=[i,...l.logs],n==="inbox"||n==="next"||n==="shipToday"){const r={id:ne(),text:e.trim()};l[n]=[...l[n],r]}return E(),g(),i.id}function Jt(e){w(),l.logs=l.logs.filter(t=>t.id!==e),E(),g()}function Yt(){return l.logs||[]}function Qt(e){if(!e||!e.trim())return l.logs||[];const t=e.toLowerCase().trim();return(l.logs||[]).filter(n=>n.content.toLowerCase().includes(t)||n.tags.some(o=>o.toLowerCase().includes(t)))}function Zt(e,t,n,o){var r;if(!n||!n.trim())throw new Error("Save As is required");if(!o||!o.trim())throw new Error("Definition of Done is required");w();const a=(r=l[e])==null?void 0:r.find(s=>s.id===t);if(!a)return null;const i={id:ne(),originalId:t,text:a.text,saveAs:n.trim(),definitionOfDone:o.trim(),shippedAt:new Date().toISOString(),fromSection:e,logLine:`${new Date().toLocaleTimeString()} | SHIPPED: ${n.trim()} â€” DoD: ${o.trim()}`};return l.shipped||(l.shipped=[]),l.shipped.unshift(i),l[e]=l[e].filter(s=>s.id!==t),E(),g(),i}function ot(){if(!l.shipped)return[];const e=new Date().toISOString().split("T")[0];return l.shipped.filter(t=>t.shippedAt&&t.shippedAt.startsWith(e))}async function Xt(e){w(),l={inbox:e.inbox||[],next:e.next||[],shipToday:e.shipToday||[],logs:e.logs||[],shipped:l.shipped||[]},await K(l),g()}async function en(){return"serviceWorker"in navigator?!!(await navigator.serviceWorker.ready).active:!1}function tn(){const e=y();let t=`# Commander

`;t+=`## Inbox
`,e.inbox.length===0?t+=`- (empty)
`:e.inbox.forEach(o=>{t+=`- ${o.text||"(empty)"}
`}),t+=`
`,t+=`## Next
`,e.next.length===0?t+=`- (empty)
`:e.next.forEach(o=>{t+=`- ${o.text||"(empty)"}
`}),t+=`
`,t+=`## Ship Today
`,e.shipToday.length===0?t+=`- (empty)
`:e.shipToday.forEach(o=>{t+=`- ${o.text||"(empty)"}
`}),t+=`
`,t+=`## Logs
`;const n=e.logs||[];return n.length===0?t+=`- (empty)
`:n.forEach(o=>{const a=new Date(o.createdAt).toLocaleString(),r=(o.content.length>100?o.content.substring(0,100)+"...":o.content).replace(/\n/g," ");t+=`- [${a}] ${r}
`}),t}function nn(){const e=y(),t={version:2,exportedAt:new Date().toISOString(),data:{inbox:e.inbox,next:e.next,shipToday:e.shipToday,logs:e.logs||[]}};return JSON.stringify(t,null,2)}function Ae(e,t,n){const o=new Blob([e],{type:n}),a=URL.createObjectURL(o),i=document.createElement("a");i.href=a,i.download=t,i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i),setTimeout(()=>URL.revokeObjectURL(a),100)}function on(){const e=tn(),t=new Date().toISOString().split("T")[0];Ae(e,`commander-${t}.md`,"text/markdown")}function Fe(){const e=nn(),t=new Date().toISOString().split("T")[0];Ae(e,`commander-${t}.json`,"application/json")}function an(e){let t;try{t=JSON.parse(e)}catch{throw new Error("Invalid JSON format")}const n=t.data||t;if(!n||typeof n!="object")throw new Error("Invalid data structure");const o={inbox:[],next:[],shipToday:[],logs:[]};return["inbox","next","shipToday"].forEach(a=>{Array.isArray(n[a])&&(o[a]=n[a].map(i=>typeof i=="string"?{id:D(),text:i}:i&&typeof i=="object"&&"text"in i?{id:i.id||D(),text:String(i.text||"")}:null).filter(Boolean))}),Array.isArray(n.logs)&&(o.logs=n.logs.map(a=>a&&typeof a=="object"&&"content"in a?{id:a.id||D(),createdAt:a.createdAt||new Date().toISOString(),source:a.source||"manual",route:a.route||"logs",tags:Array.isArray(a.tags)?a.tags:[],content:String(a.content||"")}:null).filter(Boolean)),o}function D(){return Date.now().toString(36)+Math.random().toString(36).substr(2,5)}function rn(){const e=y(),t={schemaVersion:2,appVersion:"2026-01-05T15:08:24.939Z",createdAt:new Date().toISOString(),backup:!0,data:{inbox:e.inbox||[],next:e.next||[],shipToday:e.shipToday||[],logs:e.logs||[]}};return JSON.stringify(t,null,2)}function sn(){const e=rn(),t=new Date().toISOString().split("T")[0],n=new Date().toISOString().split("T")[1].split(".")[0].replace(/:/g,"-");Ae(e,`commander-backup-${t}_${n}.json`,"application/json")}function cn(e,t){let n;try{n=JSON.parse(e)}catch{throw new Error("Invalid JSON format")}const o=n.data||n;if(!o||typeof o!="object")throw new Error("Invalid backup structure");const a={imported:{inbox:0,next:0,shipToday:0,logs:0},skipped:{inbox:0,next:0,shipToday:0,logs:0}},i={inbox:[...t.inbox||[]],next:[...t.next||[]],shipToday:[...t.shipToday||[]],logs:[...t.logs||[]]};function r(s,c,d){return s.some(f=>f.id===c.id||d&&f[d]===c[d])}return["inbox","next","shipToday"].forEach(s=>{Array.isArray(o[s])&&o[s].forEach(c=>{if(!c)return;const d=typeof c=="string"?{id:D(),text:c}:{id:c.id||D(),text:String(c.text||"")};r(i[s],d,"text")?a.skipped[s]++:(i[s].push(d),a.imported[s]++)})}),Array.isArray(o.logs)&&o.logs.forEach(s=>{if(!s||typeof s!="object"||!s.content)return;const c={id:s.id||D(),createdAt:s.createdAt||new Date().toISOString(),source:s.source||"import",route:s.route||"logs",category:s.category||"Note",tags:Array.isArray(s.tags)?s.tags:[],content:String(s.content||"")};r(i.logs,c,"content")?a.skipped.logs++:(i.logs.push(c),a.imported.logs++)}),i.logs.sort((s,c)=>new Date(c.createdAt)-new Date(s.createdAt)),{...i,stats:a}}const at=[{id:"bug",icon:"ðŸ›",label:"Bug Report",content:`[BUG] 
Context: 
Expected: 
Actual: `},{id:"idea",icon:"ðŸ’¡",label:"Idea",content:`[IDEA] 
Goal: 
First Step: `},{id:"log",icon:"ðŸªµ",label:"Daily Log",content:`#log 
Wins: 
Blockers: `},{id:"meeting",icon:"ðŸ“…",label:"Meeting Note",content:`[MEETING] 
Who: 
Action Items:
- `},{id:"MissionControl",icon:"ðŸŽ¯",label:"Morning Mission Control",content:`## ðŸŽ¯ MISSION CONTROL â€” {{DATE}}

### HUD
- Energy: /10
- Focus Target: 

### BODY
Top 3 Priorities:
{{PREVIOUS_FOCUS}}

### CLOSE BLOCK
- Review at: 
- Success = 

### LOG
#morning #mission-control`},{id:"MicroResearch",icon:"ðŸ”¬",label:"Micro Research Sprint",content:`## ðŸ”¬ MICRO RESEARCH â€” {{DATE}} {{TIME}}

### HUD
- Topic: 
- Time Box: 25min

### BODY
Question: 
Sources:
- 

Key Findings:
- 

### CLOSE BLOCK
Next Step: 

### LOG
#research #micro-sprint`},{id:"BuildBlock",icon:"ðŸ”¨",label:"Daily Build Block",content:`## ðŸ”¨ BUILD BLOCK â€” {{DATE}}

### HUD
- Project: 
- Branch: 
- Time: {{TIME}}

### BODY
Goal: 

Steps:
1. 
2. 
3. 

### CLOSE BLOCK
Definition of Done: 
Commit Message: 

### LOG
#build #dev`},{id:"NightlyDelta",icon:"ðŸŒ™",label:"Nightly System Delta",content:`## ðŸŒ™ NIGHTLY DELTA â€” {{DATE}}

### HUD
- Mood: /10
- Energy EOD: /10

### BODY
Shipped Today:
- 

Blockers Hit:
- 

Tomorrow's Focus:
- 

### CLOSE BLOCK
Gratitude: 
Learning: 

### LOG
#nightly #reflection`},{id:"WeeklyReview",icon:"ðŸ—“ï¸",label:"Weekly Review",content:`## ðŸ—“ï¸ WEEKLY REVIEW â€” {{DATE}}

### HUD
- Week Score: /10
- Big Wins: 

### BODY
Shipped this Week:
{{WEEKLY_LOGS}}

### REFLECTION
- What went well?
- What broke?
- Theme for Next Week: 

### LOG
#weekly #review`}];function it(){return at}function rt(e,t={}){const n=at.find(i=>i.id===e||i.id.toLowerCase()===(e==null?void 0:e.toLowerCase()));if(!n)return"";let o=n.content;const a=new Date;return o=o.replace(/\{\{DATE\}\}/g,a.toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"})),o=o.replace(/\{\{TIME\}\}/g,a.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})),t.previousFocus?o=o.replace("{{PREVIOUS_FOCUS}}",t.previousFocus):o=o.replace("{{PREVIOUS_FOCUS}}",`1. 
2. 
3. `),t.shippedContext&&(o=o.replace(/- \n/,t.shippedContext+`
`)),t.weeklyLogs?o=o.replace("{{WEEKLY_LOGS}}",t.weeklyLogs):o=o.replace("{{WEEKLY_LOGS}}","-"),o}const ln=[{keywords:["bug","fix","error","fail","broken","crash"],tag:"bug",category:"Bug"},{keywords:["idea","feature","maybe","wish","cool"],tag:"idea",category:"Idea"},{keywords:["meeting","call","sync","discuss","chat","meet"],tag:"meeting",category:"Meeting"},{keywords:["urgent","asap","critical","important","now","high priority"],tag:"urgent",category:"Urgent"},{keywords:["buy","order","purchase","shop","get"],tag:"shopping",category:"Shopping"}],dn=[{id:"urgent",title:"ðŸ”¥ Urgent",tags:["urgent","priority-high"]},{id:"bug",title:"ðŸ› Bugs",tags:["bug","fix"]},{id:"meeting",title:"ðŸ“… Meetings",tags:["meeting"]},{id:"idea",title:"ðŸ’¡ Ideas",tags:["idea"]},{id:"shopping",title:"ðŸ›’ Shopping",tags:["shopping"]},{id:"other",title:"ðŸ“ Tasks",tags:[]}];function un(e){const t=e.toLowerCase(),n=[];let o=null;return ln.forEach(a=>{a.keywords.some(i=>t.includes(i))&&(n.push(a.tag),o||(o=a.category))}),{tags:n,category:o}}function mn(e){const t=dn.map(n=>({...n,items:[]}));return e.forEach(n=>{const o=(n.tags||[]).map(i=>i.toLowerCase().replace("#",""));let a=!1;for(const i of t)if(i.id!=="other"&&i.tags.some(r=>o.includes(r))){i.items.push(n),a=!0;break}if(!a){const i=t.find(r=>r.id==="other");i&&i.items.push(n)}}),t}let I,Ie,k,G,Oe,F,W,st,ct,oe,p,We,Ve,lt,je,ee,dt;document.querySelector('[data-action="close-menu"]');let S=null;const He=document.getElementById("templateBtn"),ut=document.getElementById("templateOverlay"),Ge=document.getElementById("templateList"),_e=document.querySelector('[data-action="close-template"]');let h=null,L=null,T=null,ae=null,te="",R="list",B=null,V=null;const mt=500,pn={inbox:{icon:"ðŸ“¥",title:"Inbox",className:"section-inbox"},next:{icon:"ðŸ“‹",title:"Next",className:"section-next"},shipToday:{icon:"ðŸš€",title:"Ship Today",className:"section-ship"}};function gn(){I=document.getElementById("commander"),Ie=document.getElementById("captureView"),k=document.getElementById("saveStatus"),G=document.getElementById("contextMenu"),Oe=document.getElementById("logContextMenu"),F=document.getElementById("menuOverlay"),W=document.getElementById("confirmOverlay"),st=document.getElementById("confirmTitle"),ct=document.getElementById("confirmMessage"),oe=document.getElementById("importInput"),p=document.getElementById("captureTextarea"),We=document.getElementById("pasteBtn"),Ve=document.getElementById("saveLogBtn"),lt=document.getElementById("routeSelect"),je=document.getElementById("logsSearch"),ee=document.getElementById("logsList"),dt=document.getElementById("logsCount"),Ht(_),S=document.getElementById("quartermasterBtn"),Fn(),document.querySelectorAll("[data-action]").forEach(r=>{r.addEventListener("click",On)}),document.querySelectorAll("[data-move]").forEach(r=>{r.addEventListener("click",Dn)}),document.querySelectorAll("[data-log-action]").forEach(r=>{r.addEventListener("click",An)}),oe.addEventListener("change",$n),We.addEventListener("click",kn),Ve.addEventListener("click",In),He&&He.addEventListener("click",En),_e&&_e.addEventListener("click",q);const e=document.getElementById("timeBandit");e&&e.addEventListener("click",_n);const t=document.getElementById("micBtn");t&&("SpeechRecognition"in window||"webkitSpeechRecognition"in window)&&(t.hidden=!1,t.addEventListener("click",Tn)),je.addEventListener("input",Ln);const n=document.getElementById("viewToggle");n&&n.addEventListener("click",pt);const o=document.getElementById("restoreInput");o&&o.addEventListener("change",Rn);const a=document.getElementById("shipOverlay");a&&a.addEventListener("click",r=>{r.target===a&&me()});const i=document.getElementById("templateOverlay");i&&i.addEventListener("click",r=>{r.target===i&&q()}),F.addEventListener("click",r=>{r.target===F&&u()}),W.addEventListener("click",r=>{r.target===W&&M()}),window.addEventListener("online",he),window.addEventListener("offline",he),window.addEventListener("commander-command",fn),he(),document.addEventListener("keydown",Jn),_(y(),de(),X()),xt()}function fn(e){const{command:t,text:n,tags:o,priority:a,silent:i,view:r}=e.detail;switch(console.log("[UI] Received command:",t,e.detail),t){case"add-task":case"add":if(n){let s=[...o],c="inbox";a&&s.push(a==="high"?"#priority":`#${a}`);const d=O(c,n);if(s.length>0){const f=`${n} ${s.join(" ")}`;Te(c,d,f)}i||(m(`Added: ${n}`,"success"),navigator.vibrate&&navigator.vibrate(50))}break;case"log":n&&(ue(n,"automation"),i||m("Log added","info"));break;case"toggle-theme":document.body.classList.toggle("theme-light"),i||m("Theme toggled","info");break;case"focus-mode":i||m("Focus Mode activated","info"),v("tasks");break;case"navigate":r&&v(r);break}}async function he(){const e=document.getElementById("offlineIndicator");if(!e)return;!navigator.onLine?(e.textContent="ðŸ“¡ Offline",e.className="offline-indicator offline",e.hidden=!1):await en()?(e.textContent="ðŸŸ¢ Ready",e.className="offline-indicator",e.hidden=!1):e.hidden=!0}function _(e,t,n){vn(t),hn(n),Nn(),document.startViewTransition?document.startViewTransition(()=>{qe(n,e)}):qe(n,e)}function qe(e,t){e==="capture"?(I.hidden=!0,Ie.hidden=!1,gt(t)):(I.hidden=!1,Ie.hidden=!0,yn(t))}function hn(e){document.querySelectorAll(".action-btn-tab").forEach(t=>{const n=t.dataset.action;n==="view-tasks"?t.classList.toggle("active",e==="tasks"):n==="view-capture"&&t.classList.toggle("active",e==="capture")})}function yn(e){var a,i;if(R==="board"){bn(e);return}const t=document.activeElement,n=t&&t.classList.contains("item-content"),o=n?(i=(a=t.closest(".item"))==null?void 0:a.dataset)==null?void 0:i.id:null;if(n&&o){["inbox","next","shipToday"].forEach(r=>{const s=document.querySelector(`[data-section="${r}"] .section-count`);s&&(s.textContent=e[r].length)});return}if(I.innerHTML="",B){const r=document.createElement("div");r.className="filter-bar",r.innerHTML=`
            <span>Filtering: <strong>#${B}</strong></span>
            <button class="filter-clear-btn">âœ• Clear</button>
        `,r.querySelector(".filter-clear-btn").addEventListener("click",Qn),I.appendChild(r)}["inbox","next","shipToday"].forEach(r=>{let s=e[r];B&&(s=s.filter(d=>d.tags&&d.tags.some(f=>f.replace("#","").toLowerCase()===B)));const c=wn(r,s);I.appendChild(c)})}function bn(e){I.innerHTML="";const t=[...e.inbox.map(a=>({...a,_section:"inbox"})),...e.next.map(a=>({...a,_section:"next"})),...e.shipToday.map(a=>({...a,_section:"shipToday"}))],n=mn(t),o=document.createElement("div");o.className="board-container",n.forEach(a=>{const i=document.createElement("div");i.className="board-column",i.classList.add(`board-col-${a.id}`),i.innerHTML=`
            <div class="board-header">
                <span class="board-title">${a.title}</span>
                <span class="board-count">${a.items.length}</span>
            </div>
        `;const r=document.createElement("ul");r.className="board-items",a.items.forEach(s=>{const c=ft(s._section,s);c.classList.add("board-card"),r.appendChild(c)}),i.appendChild(r),o.appendChild(i)}),I.appendChild(o)}function pt(){R=R==="list"?"board":"list";const e=document.getElementById("viewToggle");e&&(e.textContent=R==="list"?"ðŸ“‹":"ðŸ“Š",e.setAttribute("title",R==="list"?"Switch to Smart Board":"Switch to List")),_(y(),de(),"tasks")}function gt(e){const t=te?Qt(te):e.logs||[];if(dt.textContent=t.length,ee.innerHTML="",t.length===0){const n=document.createElement("li");n.className="logs-empty",n.textContent=te?"No logs match your search":"No logs yet. Capture something!",ee.appendChild(n)}else t.forEach(n=>{const o=xn(n);ee.appendChild(o)})}function vn(e){switch(k.className="status-indicator",e){case"saving":k.textContent="Savingâ€¦",k.classList.add("saving");break;case"saved":k.textContent="Saved âœ“",k.classList.add("saved");break;case"error":k.textContent="Error!",k.classList.add("error");break;default:k.textContent="Ready"}}function wn(e,t){const n=pn[e],o=document.createElement("section");o.className=`section ${n.className}`,o.dataset.section=e;const a=document.createElement("header");a.className="section-header",a.innerHTML=`
    <span class="section-icon">${n.icon}</span>
    <h2 class="section-title">${n.title}</h2>
    <span class="section-count">${t.length}</span>
  `,o.appendChild(a);const i=document.createElement("ul");if(i.className="section-list",t.length===0){const r=document.createElement("li");r.className="section-empty";const c={inbox:{icon:"ðŸ“¥",text:"Inbox empty â€” capture something!"},next:{icon:"ðŸŽ¯",text:"Nothing queued up"},shipToday:{icon:"ðŸš€",text:"Ready to ship?"}}[e]||{icon:"ðŸ“­",text:"No items"};r.innerHTML=`<span class="empty-icon">${c.icon}</span><span class="empty-text">${c.text}</span>`,i.appendChild(r)}else t.forEach(r=>{const s=ft(e,r);i.appendChild(s)});return o.appendChild(i),o}function ft(e,t){const n=document.createElement("li");n.className="item",n.dataset.id=t.id,n.dataset.section=e;const o=document.createElement("span");o.className="item-bullet",n.appendChild(o);const a=document.createElement("div");if(a.className="item-content",a.contentEditable="true",a.spellcheck=!0,a.textContent=t.text,a.addEventListener("input",()=>{Te(e,t.id,a.textContent)}),a.addEventListener("blur",()=>{const s=a.textContent.trim();s!==t.text&&Te(e,t.id,s)}),a.addEventListener("keydown",s=>{if(s.key==="Enter"&&!s.shiftKey){s.preventDefault();const c=O(e,"");requestAnimationFrame(()=>{const d=document.querySelector(`[data-id="${c}"] .item-content`);d&&d.focus()})}s.key==="Backspace"&&a.textContent===""&&(s.preventDefault(),nt(e,t.id))}),n.appendChild(a),t.tags&&t.tags.length>0){const s=document.createElement("div");s.className="item-tags",t.tags.forEach(c=>{const d=document.createElement("span");d.className="item-tag",d.textContent=c.startsWith("#")?c:`#${c}`,d.addEventListener("click",f=>{f.stopPropagation(),Yn(c)}),s.appendChild(d)}),n.appendChild(s)}const i=()=>{n.classList.add("long-pressing"),T=setTimeout(()=>{n.classList.remove("long-pressing"),Cn(e,t.id)},mt)},r=()=>{n.classList.remove("long-pressing"),T&&(clearTimeout(T),T=null)};return n.addEventListener("touchstart",i,{passive:!0}),n.addEventListener("touchend",r),n.addEventListener("touchcancel",r),n.addEventListener("touchmove",r),n.addEventListener("mousedown",s=>{s.button===0&&i()}),n.addEventListener("mouseup",r),n.addEventListener("mouseleave",r),n}function xn(e){const t=document.createElement("li");t.className="log-item",t.dataset.logId=e.id;const n=new Date(e.createdAt).toLocaleString(),o=e.content.length>50?e.content.substring(0,50).replace(/\n/g," ")+"...":e.content.replace(/\n/g," ");t.innerHTML=`
    <div class="log-item-header">
      <div class="log-item-meta">
        <span class="log-item-date">${n}</span>
        <span class="log-item-preview">${ze(o)}</span>
      </div>
      <span class="log-item-source ${e.source==="clipboard"?"clipboard":""}">${e.source}</span>
    </div>
    <div class="log-item-content">
      <div class="log-item-full-text">${ze(e.content)}</div>
    </div>
  `;const a=t.querySelector(".log-item-header");a.addEventListener("click",()=>{t.classList.toggle("expanded")});const i=()=>{t.classList.add("long-pressing"),T=setTimeout(()=>{t.classList.remove("long-pressing"),Bn(e)},mt)},r=()=>{t.classList.remove("long-pressing"),T&&(clearTimeout(T),T=null)};return a.addEventListener("touchstart",i,{passive:!0}),a.addEventListener("touchend",r),a.addEventListener("touchcancel",r),a.addEventListener("touchmove",r),t}function ze(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function m(e,t="success"){const n=document.getElementById("toast");if(!n)return;const o={success:"âœ…",error:"âŒ",info:"â„¹ï¸",warning:"âš ï¸"},a=o[t]||o.success;n.textContent=`${a} ${e}`,n.className="toast show toast-"+t,navigator.vibrate&&navigator.vibrate(t==="error"?[50,50,50]:50),setTimeout(()=>{n.classList.remove("show")},3e3)}async function kn(){try{const e=await navigator.clipboard.readText();if(!e)return;const t=e.split(`
`).map(a=>a.trim()).filter(a=>a),n=/^(\-|\*|\d+\.)\s+/,o=t.filter(a=>n.test(a));if(o.length>1&&confirm(`Detected ${o.length} list items. Split them into separate Inbox tasks?`)){o.forEach(i=>{const r=i.replace(n,"").trim();r&&O("inbox",r)}),m(`âœ… Added ${o.length} items to Inbox`),v("tasks"),navigator.vibrate&&navigator.vibrate(50);return}p.value=e,p.focus()}catch(e){console.error("Failed to read clipboard:",e),alert("Permission to read clipboard denied.")}}function En(){Sn(),ut.hidden=!1}function q(){ut.hidden=!0}function Sn(){const e=it();Ge.innerHTML="";const t=document.createElement("div");t.style.cssText="display: grid; gap: 12px; grid-template-columns: repeat(2, 1fr);",e.forEach(n=>{const o=document.createElement("button");o.className="menu-btn",o.style.cssText="height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; text-align: center;",o.innerHTML=`
            <span style="font-size: 24px;">${n.icon}</span>
            <span>${n.label}</span>
        `,o.onclick=()=>ht(n.id),t.appendChild(o)}),Ge.appendChild(t)}async function ht(e){let t={};if(e==="MissionControl"){const i=(y().logs||[]).find(r=>r.tags&&r.tags.includes("#nightly")||r.saveAs&&r.saveAs.includes("NightlyDelta"));if(i){const r=i.content.match(/Tomorrow's Focus:([\s\S]*?)(?:###|$)/);if(r&&r[1]){const s=r[1].trim().split(`
`).map(c=>c.trim()).filter(c=>c.startsWith("-")).map(c=>c.replace(/^-\s*/,"").trim()).filter(c=>c).map((c,d)=>`${d+1}. ${c}`).join(`
`);s&&(t.previousFocus=s,m("ðŸ”— Ouroboros Linked: Focus recovered","info"))}}}const n=rt(e,t);n&&(p.value=n,q(),p.focus())}function Tn(){const e=document.getElementById("micBtn"),t=window.SpeechRecognition||window.webkitSpeechRecognition;if(!t)return;if(e.classList.contains("recording")){window.recognitionInstance&&window.recognitionInstance.stop();return}const n=new t;window.recognitionInstance=n,n.continuous=!1,n.interimResults=!0,n.lang="en-US",e.classList.add("recording");const o=p.getAttribute("placeholder");p.setAttribute("placeholder","Listening...");let a=p.value;a&&!a.endsWith(" ")&&(a+=" ");let i="";n.onresult=r=>{let s="",c="";for(let x=r.resultIndex;x<r.results.length;++x)r.results[x].isFinal?i+=r.results[x][0].transcript:s+=r.results[x][0].transcript,c+=r.results[x][0].transcript;const d=/^(?:protocol|template)\s+(\w+)(?:\s+(.*))?/i,f=i.trim().match(d);if(f){const x=f[1].toLowerCase(),J=f[2]||"",pe=it().find(b=>b.id===x||b.label.toLowerCase().includes(x));if(pe){let b=pe.content;J&&(b.includes("Context:")?b=b.replace("Context: ",`Context: ${J}`):b.includes("Goal:")?b=b.replace("Goal: ",`Goal: ${J}`):b+=`
${J}`),p.value=b,m(`ðŸ¤– Protocol Droid: Loaded ${pe.label}`),p.scrollTop=p.scrollHeight,e.classList.remove("recording"),window.recognitionInstance.stop();return}}p.value=a+c,p.scrollTop=p.scrollHeight},n.onend=()=>{e.classList.remove("recording"),p.setAttribute("placeholder",o),window.recognitionInstance=null,navigator.vibrate&&navigator.vibrate(50)},n.onerror=r=>{console.error("Speech recognition error",r.error),e.classList.remove("recording"),p.setAttribute("placeholder",o)},n.start()}function In(){const e=p.value.trim();if(!e){alert("Nothing to save!");return}const t=lt.value,n="manual",{tags:o}=un(e);ue(e,n,t,o),p.value="",navigator.vibrate&&navigator.vibrate(50)}function Ln(e){te=e.target.value,gt(y())}function Cn(e,t){h={section:e,id:t},document.querySelectorAll("[data-move]").forEach(n=>{n.hidden=n.dataset.move===e}),G.hidden=!1,navigator.vibrate&&navigator.vibrate(50)}function ie(){G.hidden=!0,h=null}function Bn(e){L=e,Oe.hidden=!1,navigator.vibrate&&navigator.vibrate(50)}function Ke(){Oe.hidden=!0,L=null}function Dn(e){const t=e.currentTarget.dataset.move;h&&Gt(h.section,t,h.id),ie()}function An(e){const t=e.currentTarget.dataset.logAction;if(!L){Ke();return}switch(t){case"copy":navigator.clipboard.writeText(L.content).then(()=>{navigator.vibrate&&navigator.vibrate(50)}).catch(()=>{alert("Failed to copy")});break;case"send-inbox":O("inbox",L.content);break;case"send-ship":O("shipToday",L.content);break;case"delete":Jt(L.id);break}Ke()}function On(e){var n;switch(e.currentTarget.dataset.action){case"view-tasks":v("tasks");break;case"view-capture":v("capture");break;case"add-inbox":X()!=="tasks"&&v("tasks"),ye("inbox");break;case"add-next":X()!=="tasks"&&v("tasks"),ye("next");break;case"add-ship":X()!=="tasks"&&v("tasks"),ye("shipToday");break;case"menu":Mn();break;case"close-menu":u();break;case"export-md":on(),u();break;case"export-json":Fe(),u();break;case"import-json":oe.click();break;case"undo":zt()?(qt(),u()):alert("Nothing to undo");break;case"clear-all":re("Clear All?","This will delete all items in all sections. This cannot be undone.",()=>{_t(),M(),u()});break;case"delete":h&&(nt(h.section,h.id),ie());break;case"cancel":ie();break;case"mark-shipped":h&&yt(h.section,h.id);break;case"confirm-cancel":M();break;case"confirm-yes":ae&&ae();break;case"backup":sn(),u();break;case"restore":(n=document.getElementById("restoreInput"))==null||n.click();break;case"view-shipped":Un();break;case"close-ship":case"cancel-ship":me();break;case"confirm-ship":Pn();break;case"close-template":q();break;case"diagnostics":Wn();break;case"close-diag":vt();break;case"weekly-export":Vn();break;case"check-update":jn();break;case"reset-cache":Hn();break;case"export-debug":Gn();break;case"focus-mode":u(),m("ðŸ”’ Focus Mode: Coming soon!","info");break;case"pomodoro":u(),eo();break;case"keyboard-help":u(),to();break;case"refine":Et(),no();break;case"ai-prioritize":u(),Q("prioritize");break;case"ai-breakdown":u(),Q("breakdown");break;case"ai-plan":u(),Q("planDay");break;case"daily-debrief":u(),Q("dailyDebrief");break;case"export":u(),Fe(),m("Data exported!","success");break;case"import":u(),oe.click();break;case"nuke-db":re("ðŸ’€ Nuke Database","This will DELETE ALL DATA permanently. Are you absolutely sure?",async()=>{try{indexedDB.deleteDatabase("commander-db"),localStorage.clear(),m("Database nuked. Reloading...","warning"),setTimeout(()=>location.reload(),1500)}catch{m("Failed to nuke database","error")}});break;case"ai-setup":u(),window.location.href="./ai-setup.html";break;case"automations":u(),window.location.href="./automations.html";break;case"onboarding":u(),wt();break;case"close-onboarding":Zn();break;case"help-tasks":u(),N("tasks");break;case"help-capture":u(),N("capture");break;case"help-productivity":u(),N("productivity");break;case"help-ai":u(),N("ai");break;case"help-automation":u(),N("automation");break;case"random-tip":u(),Xn();break}}function ye(e){const t=O(e,"");requestAnimationFrame(()=>{const n=document.querySelector(`[data-id="${t}"] .item-content`);n&&(n.focus(),n.scrollIntoView({behavior:"smooth",block:"center"}))})}function Mn(){F.hidden=!1}function u(){F.hidden=!0}function re(e,t,n){st.textContent=e,ct.textContent=t,ae=n,W.hidden=!1}function M(){W.hidden=!0,ae=null}async function $n(e){var n;const t=(n=e.target.files)==null?void 0:n[0];if(t){try{const o=await t.text(),a=an(o);re("Replace All Data?","This will replace all current items with the imported data. Continue?",async()=>{await Kt(a),M(),u()})}catch(o){alert(`Import failed: ${o.message}`)}e.target.value=""}}function Nn(){const e=document.getElementById("todayShipped");if(!e)return;const t=ot();e.textContent=`${t.length} shipped`}function yt(e,t){V={section:e,id:t};const n=document.getElementById("shipOverlay");n&&(n.hidden=!1);const o=document.getElementById("shipSaveAs"),a=document.getElementById("shipDoD");o&&(o.value=""),a&&(a.value="")}function me(){const e=document.getElementById("shipOverlay");e&&(e.hidden=!0),V=null}function Pn(){var n,o,a,i;if(!V)return;const e=(o=(n=document.getElementById("shipSaveAs"))==null?void 0:n.value)==null?void 0:o.trim(),t=(i=(a=document.getElementById("shipDoD"))==null?void 0:a.value)==null?void 0:i.trim();if(!e){alert("Save As is required");return}if(!t){alert("Definition of Done is required");return}try{Zt(V.section,V.id,e,t),me(),ie(),navigator.vibrate&&navigator.vibrate(100)}catch(r){alert(r.message)}}async function Rn(e){var n;const t=(n=e.target.files)==null?void 0:n[0];if(t){try{const o=await t.text(),a=cn(o,y());re("Merge Backup?",`Found ${a.stats.imported.inbox+a.stats.imported.next+a.stats.imported.shipToday} tasks and ${a.stats.imported.logs} logs to import. Duplicates will be skipped. Continue?`,async()=>{await Xt(a),M(),u(),alert(`Imported: ${a.stats.imported.inbox} inbox, ${a.stats.imported.next} next, ${a.stats.imported.shipToday} ship, ${a.stats.imported.logs} logs`)})}catch(o){alert(`Restore failed: ${o.message}`)}e.target.value=""}}function Un(){const e=ot();if(e.length===0){alert("No items shipped today yet!");return}let t=`Today's Shipped (${e.length}):

`;e.forEach((n,o)=>{t+=`${o+1}. ${n.saveAs}
   DoD: ${n.definitionOfDone}

`}),alert(t),u()}window.openShipModal=yt;const bt="2026-01-05T15:08:24.939Z";function Fn(){if(!S)return;function e(){const t=new Date().getHours(),n=new Date().getDay();let o="",a="",i="";n===0&&t>=18?(o="Weekly Review",a="ðŸ—“ï¸",i="WeeklyReview"):t>=5&&t<10?(o="Plan Day",a="â˜€ï¸",i="MissionControl"):t>=18||t<5?(o="Debrief",a="ðŸŒ™",i="NightlyDelta"):(o="Quick Capture",a="âš¡",i="capture"),S.querySelector(".label").textContent=o,S.querySelector(".icon").textContent=a,S.dataset.action=i,S.hidden=!1}e(),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&e()}),S.addEventListener("click",()=>{const t=S.dataset.action;navigator.vibrate&&navigator.vibrate(50),t==="capture"?(v("capture"),p.focus()):ht(t)})}async function Wn(){var o;const e=document.getElementById("diagOverlay");if(!e)return;const t=await tt();document.getElementById("diagVersion").textContent=bt.split("T")[0]||"dev",document.getElementById("diagSchema").textContent=`v${t.schemaVersion||"unknown"}`,document.getElementById("diagUpdated").textContent=((o=t.lastUpdated)==null?void 0:o.split("T")[0])||"never";const n=t.itemCounts||{};document.getElementById("diagCounts").textContent=`${n.inbox||0} inbox, ${n.next||0} next, ${n.logs||0} logs`,"serviceWorker"in navigator?navigator.serviceWorker.ready.then(a=>{document.getElementById("diagSW").textContent=a.active?"ðŸŸ¢ Active":"ðŸŸ¡ Waiting"}).catch(()=>{document.getElementById("diagSW").textContent="ðŸ”´ Error"}):document.getElementById("diagSW").textContent="âšª Not supported",e.hidden=!1,u()}function vt(){const e=document.getElementById("diagOverlay");e&&(e.hidden=!0)}function Vn(){const t=y().logs||[],n=new Date;n.setDate(n.getDate()-7);const o=t.filter(i=>new Date(i.createdAt)>=n);if(o.length===0){alert("No logs from the past 7 days.");return}let a=`# Commander Weekly Export
`;a+=`Exported: ${new Date().toISOString()}
`,a+=`Period: Last 7 days (${o.length} entries)

`,a+=`---

`,o.forEach(i=>{const r=new Date(i.createdAt).toLocaleString(),s=i.category||"Note";a+=`## [${s}] ${i.saveAs||"Untitled"} â€” ${r}

`,a+=i.content+`

`,a+=`---

`}),navigator.clipboard.writeText(a).then(()=>{alert(`Copied ${o.length} logs to clipboard!

Paste into ChatGPT for analysis.`),u()}).catch(()=>{const i=new Blob([a],{type:"text/markdown"}),r=URL.createObjectURL(i),s=document.createElement("a");s.href=r,s.download=`commander-weekly-${new Date().toISOString().split("T")[0]}.md`,s.click(),URL.revokeObjectURL(r),u()})}async function jn(){"serviceWorker"in navigator?(await(await navigator.serviceWorker.ready).update(),alert("Update check complete. If an update is available, it will install automatically.")):alert("Service workers not supported.")}async function Hn(){if(confirm("This will clear cached files. Your data will NOT be lost. Continue?"))try{if("caches"in window){const e=await caches.keys();await Promise.all(e.map(t=>caches.delete(t)))}m("Cache cleared. Reloading...","info"),setTimeout(()=>location.reload(!0),500)}catch(e){alert("Failed to clear cache: "+e.message)}}async function Gn(){const e=await tt(),t={exportedAt:new Date().toISOString(),appVersion:bt,schemaVersion:Ce,diagnostics:e,userAgent:navigator.userAgent,online:navigator.onLine,serviceWorker:"serviceWorker"in navigator},n=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),o=URL.createObjectURL(n),a=document.createElement("a");a.href=o,a.download=`commander-debug-${new Date().toISOString().split("T")[0]}.json`,a.click(),URL.revokeObjectURL(o),vt()}(function(){setTimeout(()=>{const t=document.querySelector("#menuOverlay .modal-body");if(t&&!document.getElementById("dailyDebriefBtn")){const n=document.querySelector('[data-action="weekly-export"]');if(n){const o=document.createElement("button");o.id="dailyDebriefBtn",o.className="menu-btn",o.innerHTML="ðŸ§  Copy Daily Debrief",o.onclick=Kn,t.insertBefore(o,n)}}},1e3)})();let A=null,$=0,Le=0;function _n(){if(A){confirm("Cancel current session?")&&(clearInterval(A),A=null,se(null));return}const e=prompt("Set Focus Timer (minutes):","25");if(!e)return;const t=parseInt(e);isNaN(t)||t<=0||qn(t)}function qn(e){Le=e,$=e*60,se($),navigator.vibrate&&navigator.vibrate([50,50,50]),m(`â³ Focus: ${e}m started`),A=setInterval(()=>{$--,se($),$<=0&&zn()},1e3)}function zn(){clearInterval(A),A=null,se(null),ue(`âœ… Focus Session: ${Le}m completed`,"auto","logs",["#focus"]),navigator.vibrate&&navigator.vibrate([200,100,200,100,500]),alert(`Time's Up! ${Le}m Session Logged.`)}function se(e){const t=document.getElementById("timeBandit");if(!t)return;if(e===null){t.textContent="â³",t.classList.remove("active");return}const n=Math.floor(e/60),o=e%60;t.textContent=`${n}:${o.toString().padStart(2,"0")}`,t.classList.add("active")}async function Kn(){const e=Yt(),t=new Date().toISOString().split("T")[0],n=e.filter(i=>i.createdAt.startsWith(t));if(n.length===0){m("No logs for today.");return}const o=n.map(i=>`- [${new Date(i.createdAt).toLocaleTimeString()}] ${i.content}`).join(`
`),a=`DATE: ${t}
LOGS:
${o}

PROMPT:
Analyze my day based on these execution logs.
1. What was the highest leverage task?
2. Where was the friction or wasted time?
3. Grade my execution (A-F) with a short explanation.
4. Suggest one improvement for tomorrow.`;try{await navigator.clipboard.writeText(a),m("ðŸ§  Debrief Prompt copied to clipboard!")}catch(i){console.error("Failed to copy",i),m("Failed to copy.")}}function Jn(e){const t=e.target.tagName.toLowerCase();if(t==="input"||t==="textarea"||e.target.isContentEditable){e.key==="Escape"&&e.target.blur();return}if(e.key==="Escape"){u(),M(),Et(),me(),q();return}if(e.key==="n"||e.key==="N"){e.preventDefault(),v("capture"),setTimeout(()=>p==null?void 0:p.focus(),100),m("New capture","info");return}if(e.key==="1"){be("inbox"),m("ðŸ“¥ Inbox","info");return}if(e.key==="2"){be("next"),m("ðŸ“‹ Next","info");return}if(e.key==="3"){be("shipToday"),m("ðŸš€ Ship Today","info");return}if(e.key==="?"||e.key==="h"){m("Shortcuts: n=new, 1/2/3=sections, Esc=close","info");return}if(e.key==="b"||e.key==="B"){pt();return}}function be(e){const t=document.querySelector(`[data-section="${e}"]`);t&&t.scrollIntoView({behavior:"smooth",block:"start"})}function Yn(e){const t=e.replace("#","").toLowerCase();B=t,m(`Filtering: #${t}`,"info"),_(y(),de(),"tasks")}function Qn(){B=null,m("Filter cleared"),_(y(),de(),"tasks")}function wt(){const e=document.getElementById("onboardingOverlay");e&&(e.hidden=!1)}function Zn(){const e=document.getElementById("onboardingOverlay");e&&(e.hidden=!0),localStorage.setItem("commander-onboarded","true")}function xt(){localStorage.getItem("commander-onboarded")||wt()}function N(e){const t={tasks:{title:"ðŸ“‹ Task Management",items:["ðŸ“¥ **Inbox**: Capture everything here first","ðŸ“‹ **Next**: Things you'll do this week","ðŸš€ **Ship Today**: Your 3-5 focus items","ðŸ’¡ Swipe right on a task to move it forward","ðŸ”„ Long-press for more options"]},capture:{title:"âœï¸ Capture",items:["ðŸ“‹ Paste clipboard content with one tap","ðŸŽ™ï¸ Use voice capture for hands-free input","ðŸ“ Templates pre-fill common log formats","ðŸ”— Share from any app to capture URLs","â° Use timestamps to track when things happened"]},productivity:{title:"ðŸŽ¯ Productivity Tools",items:["ðŸ”’ **Focus Mode**: Shows only Ship Today","ðŸ… **Pomodoro**: 25-min focus sessions","âŒ¨ï¸ **Keyboard**: Press ? for shortcuts","ðŸ”¥ **Streak**: Clear inbox daily for streak","ðŸ“Š **Board View**: See tasks by category"]},ai:{title:"ðŸ¤– AI Integration",items:["ðŸŽ¯ **Prioritize**: AI ranks your tasks","ðŸ”¨ **Break Down**: Split big tasks into steps","ðŸ“… **Plan Day**: Get a time-blocked schedule","ðŸ’¡ All prompts copy to clipboard","âœ¨ Paste into ChatGPT/Gemini for free AI!"]},automation:{title:"ðŸ”— Automation",items:["ðŸ“± **MacroDroid**: Trigger actions via URLs","ðŸ”‡ **Silent Mode**: Add tasks in background","ðŸ·ï¸ **Auto-tags**: URLs can include tags","âš¡ **Commands**: add, log, toggle-theme","ðŸ“„ Visit /automation.html for all links"]}},n=t[e]||t.tasks;kt(n.title,n.items.map(o=>`â€¢ ${o}`).join(`
`))}function Xn(){const e=["ðŸ’¡ Press ? anytime to see keyboard shortcuts","ðŸ’¡ Swipe right on a task to move it to the next section","ðŸ’¡ Long-press any task for more options","ðŸ’¡ Click on a #tag to filter by that tag","ðŸ’¡ Use Focus Mode to hide distractions","ðŸ’¡ The Quartermaster button changes based on time of day","ðŸ’¡ Export your data weekly for backup","ðŸ’¡ AI features work without API keys - just paste into ChatGPT!","ðŸ’¡ Morning is for planning, evening for reflection","ðŸ’¡ Keep Ship Today to 3-5 items max","ðŸ’¡ Use voice capture while driving (be safe!)","ðŸ’¡ Share from any app to quickly capture URLs","ðŸ’¡ Inbox Zero streaks motivate daily clearing","ðŸ’¡ Board View groups tasks by category automatically"],t=e[Math.floor(Math.random()*e.length)];m(t,"info")}function kt(e,t){const n=document.getElementById("helpModal");n&&n.remove();const o=document.createElement("div");o.id="helpModal",o.className="modal-overlay",o.innerHTML=`
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2>${e}</h2>
                <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
            </div>
            <div class="modal-body" style="white-space: pre-line; line-height: 1.8; font-size: 14px;">
                ${t.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>")}
            </div>
        </div>
    `,o.addEventListener("click",a=>{a.target===o&&o.remove()}),document.body.appendChild(o)}function Et(){G&&(G.hidden=!0),h=null}function eo(){let t=1500;m("ðŸ… Pomodoro started! 25 minutes of focus.","success");const n=setInterval(()=>{t--,t<=0&&(clearInterval(n),m("ðŸ… Pomodoro complete! Take a break.","success"),navigator.vibrate&&navigator.vibrate([200,100,200]),ue("ðŸ… Pomodoro session completed (25 min)","pomodoro"))},1e3);window._pomodoroInterval=n}function to(){kt("âŒ¨ï¸ Keyboard Shortcuts",["**j / â†“** â€” Move selection down","**k / â†‘** â€” Move selection up","**Enter** â€” Edit selected item","**d** â€” Delete selected item","**m** â€” Move to different section","**n** â€” New item","**1 / 2 / 3** â€” Jump to Inbox / Next / Ship Today","**b** â€” Toggle Board view","**Escape** â€” Clear selection / Close modal","**?** â€” Show this help"].join(`
`))}function no(){if(!h){m("Select an item first","warning");return}const t=`Help me refine this task to be more actionable and clear:

"${h.text}"

Please provide:
1. A clearer, more specific version of this task
2. Any missing context or details I should add
3. If it's too vague, break it down into smaller steps`;navigator.clipboard.writeText(t).then(()=>{m("Refine prompt copied! Paste into ChatGPT.","success")}).catch(()=>{m("Failed to copy prompt","error")})}function Q(e){const t=y(),o={prioritize:oo(t),breakdown:ao(t),planDay:io(t),dailyDebrief:ro(t)}[e];if(!o){m("Unknown prompt type","error");return}navigator.clipboard.writeText(o).then(()=>{m(`${e} prompt copied!`,"success")}).catch(()=>{m("Failed to copy prompt","error")})}function oo(e){return`Help me prioritize these tasks. Rank them by importance/urgency:

${[...e.shipToday.map(n=>`[Ship Today] ${n.text}`),...e.next.map(n=>`[Next] ${n.text}`),...e.inbox.map(n=>`[Inbox] ${n.text}`)].join(`
`)}

Please:
1. Identify my TOP 3 priorities for today
2. Explain WHY each should be prioritized
3. Flag any tasks that are vague or too large`}function ao(e){return`Break down my "Ship Today" tasks into smaller, actionable steps:

- ${e.shipToday.map(n=>n.text).join(`
- `)||"No tasks in Ship Today"}

For each task:
1. List 3-5 concrete sub-steps
2. Each step should take 30 min or less
3. Order them logically`}function io(e){const t=new Date().toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"}),n=e.shipToday.map(o=>`- ${o.text}`).join(`
`);return`Create a time-blocked schedule for today (${t}).

My priorities:
${n||"(No Ship Today items)"}

Please:
1. Create a schedule from 8 AM to 6 PM
2. Include 15-min breaks every 90 minutes
3. Put hard tasks in the morning
4. Add buffer time for unexpected items`}function ro(e){const t=(e.shipped||[]).slice(0,10),n=(e.logs||[]).slice(0,5);let o=`## What I Shipped Today
`;return t.forEach(a=>o+=`- ${a.text||a}
`),o+=`
## My Notes/Logs
`,n.forEach(a=>{var i;return o+=`- ${((i=a.content)==null?void 0:i.substring(0,100))||"Log entry"}
`}),`Review my day and provide feedback:

${o}

Please:
1. Grade my day (A/B/C/D/F)
2. Identify wins and lessons
3. Suggest one improvement for tomorrow`}xt();function so(){const e=new URLSearchParams(window.location.search);if(e.get("safemode")==="1")return{safemode:!0};const t=e.get("screen"),n=e.get("view"),o=e.get("text"),a=e.get("template"),i=e.get("command"),r=e.get("tags"),s=e.get("priority"),c=e.get("silent")==="1"||e.get("silent")==="true",d=e.get("autofocus")==="1";return!t&&!n&&!o&&!a&&!i?null:{view:n||co(t)||(o?"capture":null),template:lo(t)||a,text:o,command:i,tags:r?r.split(",").map(f=>f.trim()):[],priority:s,silent:c,autofocus:d,originalParams:e}}function co(e){return e?{"mission-control":"capture","micro-research":"capture","build-block":"capture","nightly-delta":"capture",capture:"capture",tasks:"tasks",inbox:"tasks"}[e]:null}function lo(e){return e?{"mission-control":"MissionControl","micro-research":"MicroResearch","build-block":"BuildBlock","nightly-delta":"NightlyDelta"}[e]:null}function uo(e,t){if(e){if(console.log("[Integrations] Applying launch params:",e),e.command||e.tags.length>0||e.priority||e.silent||e.text){const n=new CustomEvent("commander-command",{detail:e});window.dispatchEvent(n)}if(e.view&&t(e.view),e.view==="capture"&&setTimeout(()=>{const n=document.getElementById("captureTextarea");if(n){if(e.text&&!e.command)n.value=e.text;else if(e.template){const o=new CustomEvent("commander-fill-template",{detail:{template:e.template}});window.dispatchEvent(o)}(e.autofocus||e.text)&&!e.silent&&(n.focus(),n.value&&(n.selectionStart=n.selectionEnd=n.value.length))}},100),window.history.replaceState){const n=window.location.pathname+(e.safemode?"?safemode=1":"");window.history.replaceState({},document.title,n)}}}const St="2026-01-05T15:08:24.939Z";async function Je(){console.log(`[Commander] Starting v${St}...`);const e=so();if(e!=null&&e.safemode){mo();return}try{await z(),console.log("[Commander] Database initialized"),await Ue(),console.log("[Commander] State loaded"),gn(),console.log("[Commander] UI initialized"),uo(e,v),window.addEventListener("commander-fill-template",t=>{const n=document.getElementById("captureTextarea");n&&t.detail.template&&(n.value=rt(t.detail.template,{}))}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&(console.log("[Commander] App visible, refreshing state"),Ue())}),console.log("[Commander] Ready!")}catch(t){console.error("[Commander] Bootstrap failed:",t),po(t)}}function mo(){document.body.innerHTML=`
    <div style="padding: 20px; font-family: sans-serif; background: #0a0a0f; color: #f0f0f5; min-height: 100vh;">
      <h1 style="color: #f59e0b;">ðŸ›¡ï¸ Commander Safe Mode</h1>
      <p style="color: #a0a0b0; margin: 16px 0;">Running in minimal mode for recovery and debugging.</p>
      
      <div style="margin: 24px 0; display: flex; flex-direction: column; gap: 12px;">
        <button onclick="exportEmergencyBackup()" style="padding: 16px; background: #00d4ff; color: #000; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
          ðŸ“¦ Export Emergency Backup
        </button>
        <button onclick="location.href='./?'" style="padding: 16px; background: #1a1a24; color: #f0f0f5; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
          ðŸ”„ Try Normal Mode
        </button>
        <button onclick="clearAndReload()" style="padding: 16px; background: #ef4444; color: #fff; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
          ðŸ—‘ï¸ Clear Cache & Reload
        </button>
      </div>
      
      <div style="background: #12121a; padding: 16px; border-radius: 8px; margin-top: 24px;">
        <h3 style="margin-bottom: 12px;">Diagnostics</h3>
        <p style="font-size: 14px; color: #606070;">Version: ${St}</p>
        <p style="font-size: 14px; color: #606070;" id="swStatus">Service Worker: Checking...</p>
        <p style="font-size: 14px; color: #606070;" id="dbStatus">Database: Checking...</p>
      </div>
    </div>
  `,"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(e=>{document.getElementById("swStatus").textContent="Service Worker: "+(e.active?"ðŸŸ¢ Active":"ðŸŸ¡ Waiting")}).catch(()=>{document.getElementById("swStatus").textContent="Service Worker: ðŸ”´ Error"});try{const e=indexedDB.open("commander-db");e.onsuccess=()=>{document.getElementById("dbStatus").textContent="Database: ðŸŸ¢ Accessible"},e.onerror=()=>{document.getElementById("dbStatus").textContent="Database: ðŸ”´ Error"}}catch{document.getElementById("dbStatus").textContent="Database: ðŸ”´ Failed"}window.exportEmergencyBackup=async function(){try{const e=indexedDB.open("commander-db",3);e.onsuccess=()=>{const a=e.result.transaction("documents","readonly").objectStore("documents").get("main");a.onsuccess=()=>{const i=a.result||{},r=new Blob([JSON.stringify(i,null,2)],{type:"application/json"}),s=URL.createObjectURL(r),c=document.createElement("a");c.href=s,c.download=`commander-emergency-${new Date().toISOString().split("T")[0]}.json`,c.click(),URL.revokeObjectURL(s)}}}catch(e){alert("Export failed: "+e.message)}},window.clearAndReload=async function(){if(confirm("This will clear cached files (not your data). Continue?")){if("caches"in window){const e=await caches.keys();await Promise.all(e.map(t=>caches.delete(t)))}location.reload()}}}function po(e){document.body.innerHTML=`
    <div style="padding: 20px; font-family: sans-serif; background: #0a0a0f; color: #f0f0f5; min-height: 100vh;">
      <h1 style="color: #ef4444;">âš ï¸ Commander Failed to Start</h1>
      <p style="color: #a0a0b0; margin: 16px 0;">${e.message}</p>
      
      <div style="margin: 24px 0; display: flex; flex-direction: column; gap: 12px;">
        <button onclick="location.reload()" style="padding: 16px; background: #00d4ff; color: #000; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
          ðŸ”„ Try Again
        </button>
        <button onclick="location.href='./?safemode=1'" style="padding: 16px; background: #f59e0b; color: #000; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
          ðŸ›¡ï¸ Enter Safe Mode
        </button>
      </div>
      
      <details style="margin-top: 24px; background: #12121a; padding: 16px; border-radius: 8px;">
        <summary style="cursor: pointer; color: #606070;">Technical Details</summary>
        <pre style="font-size: 12px; color: #ef4444; margin-top: 12px; overflow-x: auto;">${e.stack||e}</pre>
      </details>
    </div>
  `}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Je):Je();
